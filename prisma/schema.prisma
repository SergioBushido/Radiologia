generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum Group {
  MAMA
  URGENCIAS
  STANDARD
}

enum PreferenceType {
  PREFERENCE
  BLOCK
  LOCK
}

model User {
  id           Int      @id @default(autoincrement())
  name         String
  email        String   @unique
  passwordHash String

  role         Role     @default(USER)
  group        Group?

  // LÃ­mite mensual de guardias (Ahora gestionado por reglas estrictas, pero mantenemos por compatibilidad)
  monthlyLimit Int      @default(999)

  createdAt    DateTime @default(now())

  // blocks       Block[] // Deprecated
  shiftsSlot1  Shift[]  @relation("slot1User")
  shiftsSlot2  Shift[]  @relation("slot2User")
  auditLogs    AuditLog[] @relation("actorUser")
  preferences  ShiftPreference[]
  vacations    Vacation[]
  sentMessages     Message[] @relation("sentMessages")
  receivedMessages Message[] @relation("receivedMessages")
}

model Message {
  id        Int      @id @default(autoincrement())
  senderId  Int
  receiverId Int
  content   String   @db.Text
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  sender    User     @relation("sentMessages", fields: [senderId], references: [id])
  receiver  User     @relation("receivedMessages", fields: [receiverId], references: [id])
}

model ShiftPreference {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  date      String   @db.VarChar(10) // YYYY-MM-DD
  
  type      PreferenceType
  points    Int      // Weight assigned by user (part of their 20 points)

  createdAt DateTime @default(now())

  @@unique([userId, date])
}

model Vacation {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  
  date      String   @db.VarChar(10) // YYYY-MM-DD
  status    String   @default("APPROVED") // PENDING, APPROVED, REJECTED

  createdAt DateTime @default(now())

  @@unique([userId, date])
}

model Shift {
  id           Int      @id @default(autoincrement())

  /// Guardar SIEMPRE como "YYYY-MM-DD" (Europe/Madrid)
  date         String   @unique @db.VarChar(10)

  slot1UserId  Int
  slot2UserId  Int

  slot1User    User     @relation("slot1User", fields: [slot1UserId], references: [id])
  slot2User    User     @relation("slot2User", fields: [slot2UserId], references: [id])

  forced       Boolean  @default(false)
  forcedReason String?  @db.VarChar(500)

  createdAt    DateTime @default(now())

  @@index([slot1UserId])
  @@index([slot2UserId])
  @@index([createdAt])
}

// Deprecated: Block model removed in favor of ShiftPreference with type=BLOCK
// model Block { ... }

model AuditLog {
  id          Int      @id @default(autoincrement())
  actorUserId Int?     // nullable por si quieres logs del sistema

  action      String   @db.VarChar(80)
  details     String?
  createdAt   DateTime @default(now())

  actorUser   User?    @relation("actorUser", fields: [actorUserId], references: [id])

  @@index([actorUserId])
  @@index([createdAt])
}
